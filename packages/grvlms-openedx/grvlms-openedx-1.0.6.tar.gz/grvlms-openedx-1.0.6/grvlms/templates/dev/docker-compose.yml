version: "3.7"

x-openedx-service:
  &openedx-service
  image: {{ DOCKER_REGISTRY }}{{ DOCKER_IMAGE_OPENEDX_DEV }}
  environment:
    SETTINGS: ${GRVLMS_EDX_PLATFORM_SETTINGS:-grvlms.development}
  volumes:
    # theme files
    - ../build/openedx/themes:/openedx/themes
    # editable requirements
    - ../build/openedx/requirements:/openedx/requirements

services:
  {% if ACTIVATE_LMS %}
  lms:
    <<: *openedx-service
    command: ./manage.py lms runserver 0.0.0.0:8000
  {% endif %}
  {% if ACTIVATE_CMS %}
  cms:
    <<: *openedx-service
    command: ./manage.py cms runserver 0.0.0.0:8000
  {% endif %}
  {% if ACTIVATE_LMS %}
  lms-worker:
    <<: *openedx-service
  {% endif %}
  {% if ACTIVATE_LMS %}
  cms-worker:
    <<: *openedx-service
  {% endif %}
  # Additional service for watching theme changes
  
  watchthemes:
    <<: *openedx-service
    command: openedx-assets watch-themes --env dev
    restart: unless-stopped
  
  {{ patch("local-docker-compose-dev-services")|indent(2) }}