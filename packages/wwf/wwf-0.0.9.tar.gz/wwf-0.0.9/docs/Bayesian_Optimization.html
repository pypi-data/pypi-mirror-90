---

title: Lesson 2 - Bayesian Optimization


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/course2020/tabular/02_Bayesian_Optimization.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/course2020/tabular/02_Bayesian_Optimization.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Lesson-Video:">Lesson Video:<a class="anchor-link" href="#Lesson-Video:"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

        <iframe
            width="400"
            height="300"
            src="https://www.youtube.com/embed/-aCtDIgbxMw?start=2887"
            frameborder="0"
            allowfullscreen
        ></iframe>
        
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea output_execute_result">
<hr>
<p>This article is also a Jupyter Notebook available to be run from the top down. There
will be code snippets that you can then run in any environment.</p>
<p>Below are the versions of <code>fastai</code>, <code>fastcore</code>, <code>wwf</code>, and <code>bayesian-optimization</code> currently running at the time of writing this:</p>
<ul>
<li><code>fastai</code>: 2.1.10 </li>
<li><code>fastcore</code>: 1.3.13 </li>
<li><code>wwf</code>: 0.0.8 </li>
<li><code>bayesian-optimization</code>: 1.2.0 </li>
</ul>
<hr>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.tabular.all</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">ADULT_SAMPLE</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;adult.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">bayes_opt</span> <span class="kn">import</span> <span class="n">BayesianOptimization</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">fit_with</span><span class="p">(</span><span class="n">lr</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">wd</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">dp</span><span class="p">:</span><span class="nb">float</span><span class="p">):</span>
  <span class="c1"># create a Learner</span>
  <span class="n">config</span> <span class="o">=</span> <span class="n">tabular_config</span><span class="p">(</span><span class="n">embed_p</span><span class="o">=</span><span class="n">dp</span><span class="p">,</span> <span class="n">ps</span><span class="o">=</span><span class="n">wd</span><span class="p">)</span>
  <span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">],</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
  
  <span class="c1"># Train for x epochs</span>
  <span class="k">with</span> <span class="n">learn</span><span class="o">.</span><span class="n">no_bar</span><span class="p">():</span>
    <span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span>
    
  <span class="c1"># Save, print, and return the overall accuracy</span>
  <span class="n">acc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">validate</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
  
  <span class="k">return</span> <span class="n">acc</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's adjust this further to show how we would go about adjusting the learning rate, embedded weight decay, drop out, and layer size:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">fit_with</span><span class="p">(</span><span class="n">lr</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">wd</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">dp</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">layer_1</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">layer_2</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">layer_3</span><span class="p">:</span><span class="nb">float</span><span class="p">):</span>

  <span class="nb">print</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">wd</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_layers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer_1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">layer_2</span><span class="p">)]</span>
  <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_layers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer_1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">layer_2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">layer_3</span><span class="p">)]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">layer_1</span><span class="p">)]</span>
  <span class="n">config</span> <span class="o">=</span> <span class="n">tabular_config</span><span class="p">(</span><span class="n">embed_p</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span>
                          <span class="n">ps</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">wd</span><span class="p">))</span>
  <span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">)</span>

  <span class="k">with</span> <span class="n">learn</span><span class="o">.</span><span class="n">no_bar</span><span class="p">()</span> <span class="ow">and</span> <span class="n">learn</span><span class="o">.</span><span class="n">no_logging</span><span class="p">():</span>
    <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>

  <span class="n">acc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">validate</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">acc</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's try it out</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;workclass&#39;</span><span class="p">,</span> <span class="s1">&#39;education&#39;</span><span class="p">,</span> <span class="s1">&#39;marital-status&#39;</span><span class="p">,</span> <span class="s1">&#39;occupation&#39;</span><span class="p">,</span> <span class="s1">&#39;relationship&#39;</span><span class="p">,</span> <span class="s1">&#39;race&#39;</span><span class="p">]</span>
<span class="n">cont_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;fnlwgt&#39;</span><span class="p">,</span> <span class="s1">&#39;education-num&#39;</span><span class="p">]</span>
<span class="n">procs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">]</span>
<span class="n">y_names</span> <span class="o">=</span> <span class="s1">&#39;salary&#39;</span>
<span class="n">y_block</span> <span class="o">=</span> <span class="n">CategoryBlock</span><span class="p">()</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">RandomSplitter</span><span class="p">()(</span><span class="n">range_of</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">to</span> <span class="o">=</span> <span class="n">TabularPandas</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">procs</span><span class="o">=</span><span class="n">procs</span><span class="p">,</span> <span class="n">cat_names</span><span class="o">=</span><span class="n">cat_names</span><span class="p">,</span> <span class="n">cont_names</span><span class="o">=</span><span class="n">cont_names</span><span class="p">,</span>
                   <span class="n">y_names</span><span class="o">=</span><span class="n">y_names</span><span class="p">,</span> <span class="n">y_block</span><span class="o">=</span><span class="n">y_block</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll declare our hyper-parameters:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hps</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1e-05</span><span class="p">,</span> <span class="mf">1e-01</span><span class="p">),</span>
      <span class="s1">&#39;wd&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">4e-4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">),</span>
      <span class="s1">&#39;dp&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
       <span class="s1">&#39;n_layers&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
       <span class="s1">&#39;layer_1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
       <span class="s1">&#39;layer_2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
       <span class="s1">&#39;layer_3&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And now we build the optimizer:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">optim</span> <span class="o">=</span> <span class="n">BayesianOptimization</span><span class="p">(</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">fit_with</span><span class="p">,</span> <span class="c1"># our fit function</span>
    <span class="n">pbounds</span> <span class="o">=</span> <span class="n">hps</span><span class="p">,</span> <span class="c1"># our hyper parameters to tune</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="c1"># 1 prints out when a maximum is observed, 0 for silent</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And now we can search!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">time</span> optim.maximize(n_iter=10)
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can grab the best results:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">optim</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{&#39;target&#39;: 0.8404483795166016, &#39;params&#39;: {&#39;dp&#39;: 0.1710613610736308, &#39;layer_1&#39;: 57.63154958927875, &#39;layer_2&#39;: 100.1567384765859, &#39;layer_3&#39;: 1930.4092799350558, &#39;lr&#39;: 0.0721697277771627, &#39;n_layers&#39;: 2.868052690189961, &#39;wd&#39;: 0.035039066808375346}}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And with a few conversions we see:</p>
<ul>
<li>The best number of layers was 2</li>
<li>The first layer a size of 57</li>
<li>The second layer a size of 100
And then of course our other hyper paramters</li>
</ul>

</div>
</div>
</div>
</div>
 

