{
  "friendly_name": "Delete Devices from SL1",
  "description": "Deletes Devices from SL1",
  "configuration": "",
  "author": "ScienceLogic Inc.",
  "version": "2.0.0",
  "app_variables": [
    {
      "name": "sl1_hostname",
      "value": "${config.sl1_host}",
      "description": "The SL1 hostname to participate in the sync",
      "sample_value": "10.2.253.115",
      "required": true
    },
    {
      "name": "sl1_db_host",
      "description": "The SL1 host to use for DB connections",
      "sample_value": "10.2.11.48",
      "required": true,
      "value": "${config.sl1_db_host}"
    },
    {
      "name": "sl1_user",
      "value": "${config.sl1_user}",
      "description": "The r authenticating to SL1",
      "sample_value": "em7admin",
      "required": true
    },
    {
      "name": "sl1_password",
      "value": "${config.sl1_password}",
      "description": "the password for authenticating with SL1",
      "sample_value": "em7password",
      "required": true
    },
    {
      "name": "sl1_db_user",
      "description": "the user for authenticating with the SL1 DB",
      "value": "${config.sl1_db_user}",
      "sample_value": "root",
      "required": true
    },
    {
      "name": "sl1_db_password",
      "description": "the password for authenticating with the SL1 DB",
      "value": "${config.sl1_db_password}",
      "sample_value": "em7admin",
      "required": true
    }
  ],
  "steps": [
    {
      "name": "Pull Disabled Devices from VCUG in SL1",
      "file": "PullAndProcessDisabledDevices",
      "syncpack": "servicenow_cmdb_syncpack",
      "method": "GET",
      "chunk_size": 1000,
      "chunk_name_for_pos_in_url": "offset",
      "chunk_name_for_max_in_url": "limit",
      "chunk_name_for_returned": "total_returned",
      "chunk_name_for_total": "total_matched",
      "expected_http_response": 200,
      "prefix_url": "https://${appvar.sl1_hostname}",
      "username": "${appvar.sl1_user}",
      "password": "${appvar.sl1_password}",
      "read_timeout": "${appvar.read_timeout}",
      "max_age": "${appvar.max_age}",
      "target_vcug": "${appvar.target_vcug}",
      "output_to": [
        "Pull Affected Device Info from SL1 (GQL)",
        "Pull Affected Device Info from SL1 (MySQL)"
      ]
    },
    {
      "name": "Pull Affected Device Info from SL1 (GQL)",
      "file": "OptionalQueryGQL",
      "syncpack": "servicenow_base_syncpack",
      "data_from": [
        "Pull Disabled Devices from VCUG in SL1"
      ],
      "enable": "${enabled}",
      "follow_cursor": true,
      "edges_only": true,
      "query": "query SingleDeviceFetchWithChildren($search: DeviceSearch, $order: [ConnectionOrder]) { devices(first: 500, search: $search, after: \"\", order: $order) { pageInfo { hasNextPage matchCount } edges { cursor device: node { ...deviceWithChildren } } } } fragment deviceWithChildren on Device { id collectorGroup { id } componentDescendants { edges { child: node { id collectorGroup { id } } } } }",
      "variables": "${gql_vars}",
      "query_url": "https://${appvar.sl1_hostname}/gql",
      "read_timeout": "${appvar.read_timeout}",
      "username": "${appvar.sl1_user}",
      "password": "${appvar.sl1_password}",
      "output_to": [
        "Verify Device Delete Requests"
      ]
    },
    {
      "name": "Pull Affected Device Info from SL1 (MySQL)",
      "file": "MySqlSelect",
      "syncpack": "base_steps_syncpack",
      "data_from": [
        "Pull Disabled Devices from VCUG in SL1"
      ],
      "host": "${appvar.sl1_db_host}",
      "database": "master",
      "username": "${appvar.sl1_db_user}",
      "password": "${appvar.sl1_db_password}",
      "select_query": "${mysql_query}",
      "output_to": [
        "Verify Device Delete Requests"
      ]
    },
    {
      "name": "Verify Device Delete Requests",
      "file": "VerifyDeviceDeletes",
      "syncpack": "servicenow_cmdb_syncpack",
      "data_from": [
        "Pull Affected Device Info from SL1 (GQL)",
        "Pull Affected Device Info from SL1 (MySQL)"
      ],
      "output_to": [
        "Delete Devices"
      ]
    },
    {
      "name": "Delete Devices",
      "file": "TriggerApplication",
      "syncpack": "base_steps_syncpack",
      "trigger_app": "bulk_delete_devices",
      "data_from": [
        "Verify Device Delete Requests"
      ],
      "wait_for_child_completion": false,
      "input_iterator": true,
      "value_as": "did"
    }
  ]
}
