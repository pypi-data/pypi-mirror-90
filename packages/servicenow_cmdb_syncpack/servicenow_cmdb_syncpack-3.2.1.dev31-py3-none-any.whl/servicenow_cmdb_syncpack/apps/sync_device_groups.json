{
  "friendly_name": "Sync Device Groups from SL1 to ServiceNow",
  "description": "Pulls Device Groups from SL1 via GQL and syncs to ServiceNow",
  "configuration": "",
  "author": "ScienceLogic Inc.",
  "version": "3.0.0",
  "meta": {
    "hidden": false
  },
  "app_variables":[

    {
      "name": "sl1_hostname",
      "value": "${config.sl1_host}",
      "description": "The SL1 hostname to participate in the sync",
      "sample_value": "10.2.253.115",
      "required": true
    },
    {
      "name": "sl1_db_host",
      "description": "The SL1 host to use for DB connections",
      "sample_value": "10.2.11.48",
      "required": true,
      "value": "${config.sl1_db_host}"
    },
    {
      "name": "sl1_user",
      "value": "${config.sl1_user}",
      "description": "The user authenticating to SL1",
      "sample_value": "em7admin",
      "required": true
    },
    {
      "name": "sl1_password",
      "value": "${config.sl1_password}",
      "description": "the password for authenticating with SL1",
      "sample_value": "em7password",
      "required": true
    },
    {
      "name": "sl1_db_user",
      "description": "the user for authenticating with the SL1 DB",
      "value": "${config.sl1_db_user}",
      "sample_value": "root",
      "required": true
    },
    {
      "name": "sl1_db_password",
      "description": "the password for authenticating with the SL1 DB",
      "value": "${config.sl1_db_password}",
      "sample_value": "em7admin",
      "required": true
    },
    {
      "name": "snow_hostname",
      "value": "${config.snow_host}",
      "description": "The ServiceNow hostname to participate in the sync",
      "sample_value": "10.2.253.233",
      "required": true
    },
    {
      "name": "snow_user",
      "value": "${config.snow_user}",
      "description": "The username for authenticating to ServiceNow",
      "sample_value": "snowadmin",
      "required": true
    },
    {
      "name": "snow_password",
      "value": "${config.snow_password}",
      "description": "The password for authenticating to ServiceNow",
      "sample_value": "snowpassword",
      "required": true
    },
    {
      "name": "region",
      "value": "${config.region}",
      "description": "Unique identifier for IS+SL1",
      "sample_value": "ScienceLogicRegion",
      "required": true
    }
  ],
  "steps":[
    {
      "name": "Pull Device Groups from SL1 (GQL)",
      "file": "QueryGQL",
      "syncpack": "base_steps_syncpack",
      "follow_cursor": true,
      "edges_only": true,
      "query": "fragment DeviceGroup on DeviceGroup { id name devices { ...device }} fragment device on DeviceConnection { edges { node { id }}} query DeviceGroupFetch($search: DeviceGroupSearch, $order: [ConnectionOrder]) { deviceGroups(first: 500, search: $search, after: \"\", order: $order) { pageInfo { hasNextPage matchCount } edges { cursor deviceGroup: node { ...DeviceGroup }}}}",
      "query_url": "https://${appvar.sl1_hostname}/gql",
      "username": "${appvar.sl1_user}",
      "password": "${appvar.sl1_password}",
      "read_timeout": "${appvar.read_timeout}",
      "output_to": ["Process Groups"]
    },
    {
      "name": "Pull Group IDs from SL1 (MySQL)",
      "file": "MySqlSelect",
      "syncpack": "base_steps_syncpack",
      "host": "${appvar.sl1_db_host}",
      "database": "master_dev",
      "username": "${appvar.sl1_db_user}",
      "password": "${appvar.sl1_db_password}",
      "select_query": "select dgid, dg_guid from master_dev.device_groups",
      "output_to": ["Process Groups"]
    },
    {
      "name": "Process Groups",
      "file": "ProcessGroups",
      "syncpack": "servicenow_cmdb_syncpack",
      "region": "${appvar.region}",
      "Sync_Empty_Groups": "${appvar.Sync_Empty_Groups}",
      "data_from": [
        "Pull Device Groups from SL1 (GQL))",
        "Pull Group IDs from SL1 (MySQL)"
      ],
      "output_to": ["Post Groups to ServiceNow"]
    },
    {
      "name": "Post Groups to ServiceNow",
      "file": "QueryREST",
      "syncpack": "base_steps_syncpack",
      "data_from": ["Process Groups"],
      "method": "POST",
      "debug_packet": true,
      "expected_http_response": 200,
      "prefix_url": "https://${appvar.snow_hostname}",
      "username": "${appvar.snow_user}",
      "password": "${appvar.snow_password}",
      "read_timeout": "${appvar.read_timeout}",
      "payload_from_input": true,
      "relative_url": "/api/x_sclo_scilogic/v1/sciencelogic/cmdb_group"
    }
  ]
}
