{
  "friendly_name": "Pull and Post Discovery Logs",
  "description": "Pull Discovery Session Logs from SL1 and Post updates to ServiceNow",
  "configuration": "",
  "author": "ScienceLogic Inc.",
  "version": "3.0.0",
  "meta": {
    "hidden": true
  },
  "app_variables": [
    {
      "name": "sl1_hostname",
      "value": "${config.sl1_host}",
      "description": "The SL1 hostname to participate in the sync",
      "sample_value": "10.2.253.115",
      "required": true
    },
    {
      "name": "snow_hostname",
      "value": "${config.snow_host}",
      "description": "The ServiceNow hostname to participate in the sync",
      "sample_value": "10.2.253.233",
      "required": true
    },
    {
      "name": "sl1_user",
      "value": "${config.sl1_user}",
      "description": "The r authenticating to SL1",
      "sample_value": "em7admin",
      "required": true
    },
    {
      "name": "snow_user",
      "value": "${config.snow_user}",
      "description": "The username for authenticating to ServiceNow",
      "sample_value": "snowadmin",
      "required": true
    },
    {
      "name": "sl1_password",
      "value": "${config.sl1_password}",
      "description": "the password for authenticating with SL1",
      "sample_value": "em7password",
      "required": true
    },
    {
      "name": "snow_password",
      "value": "${config.snow_password}",
      "description": "The password for authenticating to ServiceNow",
      "sample_value": "snowpassword",
      "required": true
    }
  ],
  "steps": [
    {
      "name": "Load Last Processed Log Timestamp from Cache",
      "file": "ReadFromCache",
      "syncpack": "base_steps_syncpack",
      "save_key": "discovery_session_logs_${appvar.region}_${_appvar.sys_id}_${_appvar.slid}",
      "lookup_type": "equals",
      "output_to": [
        "Pull Discovery Session Logs from ScienceLogic"
      ]
    },
    {
      "name": "Pull Discovery Session Logs from ScienceLogic",
      "file": "PullDiscoverySessionLogs",
      "syncpack": "servicenow_cmdb_syncpack",
      "prefix_url": "https://${appvar.sl1_hostname}",
      "relative_url": "${_appvar.uri}",
      "method": "get",
      "result_key": "result_set",
      "sys_id": "${_appvar.sys_id}",
      "region": "${appvar.region}",
      "username": "${appvar.sl1_user}",
      "password": "${appvar.sl1_password}",
      "read_timeout": "${appvar.read_timeout}",
      "data_from": [
        "Load Last Processed Log Timestamp from Cache"
      ],
      "output_to": [
        "Post Updates to ServiceNow",
        "Post Device Updates to SL1"
      ],
      "Closed_Success_State": "${appvar.Closed_Success_State}",
      "affected_cis": "${_appvar.affected_cis}",
      "sys_id_target": "${appvar.sys_id_target}",
      "ci_class_target": "${appvar.ci_class_target}"
    },
    {
      "name": "Post Updates to ServiceNow",
      "file": "QueryREST",
      "syncpack": "base_steps_syncpack",
      "data_from": [
        "Pull Discovery Session Logs from ScienceLogic"
      ],
      "prefix_url": "https://${appvar.snow_hostname}",
      "relative_url": "/x_sclo_scilogic_import_service_request.do?JSONv2&sysparm_action=insertMultiple",
      "method": "post",
      "payload_from_input": true,
      "url_from_input": true,
      "payload": "${snow_payload}",
      "username": "${appvar.snow_user}",
      "password": "${appvar.snow_password}",
      "read_timeout": "${appvar.read_timeout}"
    },
    {
      "name": "Post Device Updates to SL1",
      "file": "TriggerApplication",
      "syncpack": "base_steps_syncpack",
      "data_from": ["Pull Discovery Session Logs from ScienceLogic"],
      "trigger_app": "post_attribute_rest_calls",
      "wait_for_child_completion": false,
      "foreach": "${sl1_payloads}",
      "value_as": "full_payload",
      "app_vars": [
        {
          "name": "did",
          "value": "${did}"
        },
        {
          "name": "attributes",
          "value": "${payload}"
        }
      ]
    }
  ]
}
